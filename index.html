<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drone Flight Analysis Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; }
        #map { height: 400px; }
        .dashboard { display: flex; justify-content: space-around; margin-top: 20px; }
        .chart-container { width: 45%; }
    </style>
</head>
<body>
    <h1>Drone Flight Analysis Dashboard</h1>
    <input type="file" id="file-input" multiple>
    <button onclick="uploadFiles()">Upload and Analyze</button>

    <div id="map"></div>
    <div class="dashboard">
        <div class="chart-container">
            <canvas id="altitude-chart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="speed-chart"></canvas>
        </div>
    </div>
     <div id="image-gallery"></div>

    <script>
        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        let altitudeChart, speedChart;

        function uploadFiles() {
            const input = document.getElementById('file-input');
            const files = input.files;
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files[]', files[i]);
            }

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.telemetry) {
                    updateDashboard(data.telemetry);
                }
                if (data.kml || data.geojson) {
                    visualizePath(data.kml || data.geojson);
                }
                 if (data.images) {
                    displayImages(data.images);
                }
            });
        }
        
        function updateDashboard(telemetry) {
            const labels = telemetry.map(d => d.flyTime);
            const altitudeData = telemetry.map(d => d.altitude);
            const speedData = telemetry.map(d => d.speed);

            if (altitudeChart) altitudeChart.destroy();
            altitudeChart = new Chart(document.getElementById('altitude-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Altitude',
                        data: altitudeData,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                }
            });
            
            if (speedChart) speedChart.destroy();
            speedChart = new Chart(document.getElementById('speed-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Speed',
                        data: speedData,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }]
                }
            });
        }
        
        function visualizePath(geojsonData) {
            const layer = L.geoJSON(JSON.parse(geojsonData)).addTo(map);
            map.fitBounds(layer.getBounds());
        }
        
        function displayImages(imageFilenames) {
            const gallery = document.getElementById('image-gallery');
            gallery.innerHTML = '<h2>Photos</h2>';
            imageFilenames.forEach(filename => {
                // In a real app, you would have URLs to the images
                const imgElement = document.createElement('p');
                imgElement.textContent = filename;
                gallery.appendChild(imgElement);
            });
        }
    </script>
</body>
</html>
